<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bear Roster Viewer</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex flex-wrap gap-3 items-center">
      <h1 class="text-xl font-bold">Bear Roster Viewer</h1>
      <input id="event" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="event slug (예: bear-20250919)" />
      <button id="btnLoad" class="px-3 py-2 rounded bg-indigo-500 font-semibold">불러오기</button>
      <div class="ml-auto flex items-center gap-2">
        <input id="search" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="검색" />
        <button id="btnSearch" class="px-3 py-2 rounded bg-slate-700">검색</button>
      </div>
    </header>

    <div class="overflow-auto rounded border border-slate-700">
      <table class="min-w-[900px] w-full text-sm">
        <thead class="bg-slate-800">
          <tr>
            <th class="p-2 cursor-pointer sort" data-col="seq">순번</th>
            <th class="p-2 cursor-pointer sort" data-col="name">이름</th>
            <th class="p-2 cursor-pointer sort" data-col="power_m">전투력(백만)</th>
            <th class="p-2 cursor-pointer sort" data-col="gold">순금</th>
            <th class="p-2 cursor-pointer sort" data-col="wish_slot">희망 시간대</th>
            <th class="p-2 cursor-pointer sort" data-col="seat">곰자리</th>
            <th class="p-2">비고</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="flex items-center gap-3">
      <button id="prev" class="px-3 py-2 rounded bg-slate-700">Prev</button>
      <span id="pageInfo" class="text-slate-300"></span>
      <button id="next" class="px-3 py-2 rounded bg-slate-700">Next</button>
      <select id="size" class="ml-3 px-2 py-1 rounded bg-slate-800 border border-slate-700">
        <option>10</option><option selected>20</option><option>30</option><option>50</option>
      </select>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
let state = { event:'', page:1, size:20, total:0, sort:[{col:'seq',dir:'asc'}], search:'', rows:[] };

function sortParam(){ return state.sort.map(s=>`${s.col}:${s.dir}`).join(','); }
async function loadPage() {
  if(!state.event) return alert('event slug 입력');
  const url = new URL(location.origin + `/api/members/${encodeURIComponent(state.event)}`);
  url.searchParams.set('page', String(state.page));
  url.searchParams.set('size', String(state.size));
  url.searchParams.set('sort', sortParam());
  if (state.search) url.searchParams.set('search', state.search);
  const r = await fetch(url); const j = await r.json();
  if(!j.ok) return alert(j.error || r.status);
  state.rows = j.rows; state.total = j.total;
  render(); renderPage();
}
function render() {
  const tb = $('#tbody'); tb.innerHTML='';
  for (const r of state.rows) {
    const tr = document.createElement('tr');
    tr.className = 'odd:bg-slate-900 even:bg-slate-950 hover:bg-slate-800';
    tr.innerHTML = `
      <td class="p-2">${r.seq}</td>
      <td class="p-2">${r.name ?? ''}</td>
      <td class="p-2">${r.power_m ?? ''}</td>
      <td class="p-2">${r.gold ?? ''}</td>
      <td class="p-2">${r.wish_slot ?? ''}</td>
      <td class="p-2">${r.seat ?? ''}</td>
      <td class="p-2">${r.note ?? ''}</td>`;
    tb.appendChild(tr);
  }
}
function renderPage(){
  const maxPage = Math.max(1, Math.ceil(state.total / state.size));
  $('#pageInfo').textContent = `Page ${state.page}/${maxPage} · Total ${state.total}`;
}
$('#prev').onclick = ()=>{ if(state.page>1){state.page--; loadPage();} };
$('#next').onclick = ()=>{ const m=Math.max(1,Math.ceil(state.total/state.size)); if(state.page<m){state.page++; loadPage();} };
$('#size').onchange = ()=>{ state.size = Number($('#size').value); state.page=1; loadPage(); };
$('#btnLoad').onclick = ()=>{ state.event = $('#event').value.trim(); state.page=1; loadPage(); };
$('#btnSearch').onclick = ()=>{ state.search = $('#search').value.trim(); state.page=1; loadPage(); };
$$('.sort').forEach(th=>{
  th.addEventListener('click', ()=>{
    const col = th.dataset.col;
    const cur = state.sort.find(s=>s.col===col);
    state.sort = [{ col, dir: cur && cur.dir==='asc' ? 'desc' : 'asc' }];
    state.page=1; loadPage();
  });
});
</script>
</body>
</html>
