<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bear Roster Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100">
  <div class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex flex-wrap gap-3 items-center">
      <h1 class="text-xl font-bold">Bear Roster Editor</h1>
      <input id="event" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="event slug (예: bear-20250919)" />
      <input id="editKey" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="EDIT_KEY" />
      <button id="btnLoad" class="px-3 py-2 rounded bg-indigo-500 font-semibold">불러오기</button>
      <button id="btnSave" class="px-3 py-2 rounded bg-emerald-500 font-semibold">저장</button>
      <button id="btnAddRow" class="px-3 py-2 rounded bg-slate-700">행 추가</button>
      <button id="btnDelSel" class="px-3 py-2 rounded bg-red-600">선택 삭제</button>
      <div class="ml-auto flex items-center gap-2">
        <input id="search" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="검색(이름/시간/자리/비고)" />
        <button id="btnSearch" class="px-3 py-2 rounded bg-slate-700">검색</button>
      </div>
    </header>

    <!-- Paste Meta Area -->
    <details class="bg-slate-800 rounded border border-slate-700">
      <summary class="cursor-pointer px-3 py-2 font-semibold">메타/표 붙여넣기 → 파싱 후 테이블에 병합</summary>
      <div class="p-3 space-y-3">
        <textarea id="paste" class="w-full h-40 bg-slate-900 border border-slate-700 rounded p-2" placeholder="여기에 원본 표(탭/공백 구분) 붙여넣기"></textarea>
        <div class="flex gap-2">
          <button id="btnParse" class="px-3 py-2 rounded bg-slate-700">파싱 미리보기</button>
          <button id="btnMerge" class="px-3 py-2 rounded bg-indigo-600">현재 데이터에 병합</button>
        </div>
        <pre id="preview" class="text-xs bg-slate-900 p-2 rounded border border-slate-700 overflow-x-auto"></pre>
      </div>
    </details>

    <!-- Table -->
    <div class="overflow-auto rounded border border-slate-700">
      <table class="min-w-[900px] w-full text-sm">
        <thead class="bg-slate-800">
          <tr>
            <th class="p-2 w-10"><input id="chkAll" type="checkbox"/></th>
            <th class="p-2 cursor-pointer sort" data-col="seq">순번</th>
            <th class="p-2 cursor-pointer sort" data-col="name">이름</th>
            <th class="p-2 cursor-pointer sort" data-col="power_m">전투력(백만)</th>
            <th class="p-2 cursor-pointer sort" data-col="gold">순금</th>
            <th class="p-2 cursor-pointer sort" data-col="wish_slot">희망 시간대</th>
            <th class="p-2 cursor-pointer sort" data-col="seat">곰자리</th>
            <th class="p-2">비고</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex items-center gap-3">
      <button id="prev" class="px-3 py-2 rounded bg-slate-700">Prev</button>
      <span id="pageInfo" class="text-slate-300"></span>
      <button id="next" class="px-3 py-2 rounded bg-slate-700">Next</button>
      <select id="size" class="ml-3 px-2 py-1 rounded bg-slate-800 border border-slate-700">
        <option>10</option><option selected>20</option><option>30</option><option>50</option>
      </select>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

let state = {
  event: '',
  page: 1,
  size: 20,
  total: 0,
  sort: [{ col: 'seq', dir: 'asc' }],   // 다중정렬 가능
  search: '',
  rows: [],
  edited: new Map(), // key: seq, value: row
  selected: new Set()
};

function sortToParam() {
  return state.sort.map(s => `${s.col}:${s.dir}`).join(',');
}

async function loadPage() {
  if (!state.event) return alert('event slug 입력');
  const url = new URL(location.origin + `/api/members/${encodeURIComponent(state.event)}`);
  url.searchParams.set('page', String(state.page));
  url.searchParams.set('size', String(state.size));
  url.searchParams.set('sort', sortToParam());
  if (state.search) url.searchParams.set('search', state.search);
  const r = await fetch(url);
  const j = await r.json();
  if (!j.ok) return alert(j.error || r.status);
  state.rows = j.rows;
  state.total = j.total;
  renderTable();
  renderPageInfo();
}

function renderPageInfo() {
  const maxPage = Math.max(1, Math.ceil(state.total / state.size));
  $('#pageInfo').textContent = `Page ${state.page}/${maxPage} · Total ${state.total}`;
}

function tdEditable(key, val) {
  const input =
    `<input data-key="${key}" class="w-full bg-transparent focus:outline-none" value="${(val ?? '').toString().replace(/"/g,'&quot;')}" />`;
  return input;
}

function renderTable() {
  const tb = $('#tbody');
  tb.innerHTML = '';
  state.selected.clear();
  $('#chkAll').checked = false;

  for (const row of state.rows) {
    const tr = document.createElement('tr');
    tr.className = 'odd:bg-slate-900 even:bg-slate-950 hover:bg-slate-800';

    tr.innerHTML = `
      <td class="p-2 text-center"><input type="checkbox" data-sel="${row.seq}" /></td>
      <td class="p-2">${tdEditable('seq', row.seq)}</td>
      <td class="p-2">${tdEditable('name', row.name)}</td>
      <td class="p-2">${tdEditable('power_m', row.power_m ?? '')}</td>
      <td class="p-2">${tdEditable('gold', row.gold ?? '')}</td>
      <td class="p-2">${tdEditable('wish_slot', row.wish_slot ?? '')}</td>
      <td class="p-2">${tdEditable('seat', row.seat ?? '')}</td>
      <td class="p-2">${tdEditable('note', row.note ?? '')}</td>
    `;

    // 체크박스
    tr.querySelector(`input[type=checkbox][data-sel]`).addEventListener('change', (e) => {
      const seq = Number(e.target.dataset.sel);
      if (e.target.checked) state.selected.add(seq);
      else state.selected.delete(seq);
    });

    // 편집 추적
    tr.querySelectorAll('input[data-key]').forEach(inp => {
      inp.addEventListener('change', () => {
        const k = inp.dataset.key;
        const v = inp.value;
        const current = { ...row };
        current[k] = normalize(k, v);
        state.edited.set(current.seq, current);
      });
    });

    tb.appendChild(tr);
  }
}

function normalize(key, v) {
  if (['seq','gold'].includes(key)) {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  if (key === 'power_m') {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  return v ?? null;
}

$('#prev').addEventListener('click', () => {
  if (state.page > 1) { state.page--; loadPage(); }
});
$('#next').addEventListener('click', () => {
  const maxPage = Math.max(1, Math.ceil(state.total / state.size));
  if (state.page < maxPage) { state.page++; loadPage(); }
});
$('#size').addEventListener('change', () => {
  state.size = Number($('#size').value);
  state.page = 1;
  loadPage();
});
$('#btnLoad').addEventListener('click', () => {
  state.event = $('#event').value.trim();
  state.page = 1;
  loadPage();
});
$('#btnSearch').addEventListener('click', () => {
  state.search = $('#search').value.trim();
  state.page = 1;
  loadPage();
});
$('#chkAll').addEventListener('change', (e) => {
  state.selected.clear();
  $$('#tbody input[type=checkbox][data-sel]').forEach(c => {
    c.checked = e.target.checked;
    if (c.checked) state.selected.add(Number(c.dataset.sel));
  });
});

$$('.sort').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    const cur = state.sort.find(s => s.col === col);
    if (!cur) {
      state.sort = [{ col, dir: 'asc' }];
    } else {
      cur.dir = cur.dir === 'asc' ? 'desc' : 'asc';
      state.sort = [cur];
    }
    state.page = 1;
    loadPage();
  });
});

$('#btnAddRow').addEventListener('click', () => {
  if (!state.event) return alert('event slug 먼저 입력');
  // 새 seq: 현재 페이지에서 가장 큰 seq + 1 (간편)
  const maxSeq = state.rows.reduce((m,r)=>Math.max(m, Number(r.seq)||0), 0);
  const newRow = { seq: maxSeq + 1, name:'', power_m:null, gold:null, wish_slot:'', seat:'', note:'' };
  state.rows.unshift(newRow);
  renderTable();
  state.edited.set(newRow.seq, { event_slug: state.event, ...newRow });
});

$('#btnDelSel').addEventListener('click', async () => {
  if (!state.selected.size) return;
  if (!confirm(`${state.selected.size}건 삭제할까요?`)) return;
  const event = $('#event').value.trim();
  const r = await fetch(`/api/members/${encodeURIComponent(event)}`, {
    method: 'POST',
    headers: { 'content-type': 'application/json', 'x-edit-key': $('#editKey').value.trim() },
    body: JSON.stringify({ deletes: Array.from(state.selected).map(seq => ({ seq })) })
  });
  const j = await r.json();
  if (!j.ok) return alert(j.error || '삭제 실패');
  state.edited.clear();
  loadPage();
});

$('#btnSave').addEventListener('click', async () => {
  if (!state.edited.size) return alert('변경사항이 없습니다.');
  const event = $('#event').value.trim();
  const upserts = Array.from(state.edited.values()).map(r => ({
    seq: r.seq,
    name: r.name ?? '',
    power_m: r.power_m ?? null,
    gold: r.gold ?? null,
    wish_slot: r.wish_slot ?? null,
    seat: r.seat ?? null,
    note: r.note ?? null
  }));
  const r = await fetch(`/api/members/${encodeURIComponent(event)}`, {
    method: 'POST',
    headers: { 'content-type': 'application/json', 'x-edit-key': $('#editKey').value.trim() },
    body: JSON.stringify({ upserts })
  });
  const j = await r.json();
  if (!j.ok) return alert(j.error || '저장 실패');
  state.edited.clear();
  loadPage();
});

/* ===== 메타 파서: 붙여넣은 표 → {seq,name,power_m,gold,wish_slot,seat,note}[] ===== */
function parseMeta(raw) {
  // 탭/여러 공백 구분, 첫 행이 헤더라고 가정
  const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  if (lines.length < 2) return [];
  const header = lines.shift();
  const cols = header.split(/\t| {2,}|\s{1,}/).map(h => h.trim());

  function idxMatch(keys) {
    for (const k of keys) {
      let i = cols.findIndex(c => c.replace(/\s+/g,'').includes(k));
      if (i >= 0) return i;
    }
    return -1;
  }
  const iSeq  = idxMatch(['순번','No','Index']);
  const iName = idxMatch(['이름','Name']);
  const iPow  = idxMatch(['전투력(백만)','전투력','Power']);
  const iGold = idxMatch(['순금','Gold']);
  const iWish = idxMatch(['희망시간대','희망','시간','Slot']);
  const iSeat = idxMatch(['곰자리','자리','열','Seat']);
  const iNote = idxMatch(['비고','메모','Note','Remarks']);

  const out = [];
  for (const line of lines) {
    const parts = line.split(/\t| {2,}|\s{1,}/).map(s => s.trim());
    const row = {
      seq:  iSeq  >= 0 ? Number(parts[iSeq]) : null,
      name: iName >= 0 ? parts[iName] : '',
      power_m: iPow >= 0 ? Number((parts[iPow] || '').replace(/[^0-9.]/g,'')) : null,
      gold: iGold >= 0 ? Number((parts[iGold] || '').replace(/[^0-9]/g,'')) : null,
      wish_slot: iWish >= 0 ? parts[iWish] || '' : '',
      seat: iSeat >= 0 ? parts[iSeat] || '' : '',
      note: iNote >= 0 ? parts[iNote] || '' : ''
    };
    if (row.seq && row.name) out.push(row);
  }
  return out;
}

$('#btnParse').addEventListener('click', () => {
  const rows = parseMeta($('#paste').value);
  $('#preview').textContent = JSON.stringify(rows.slice(0, 10), null, 2) + (rows.length > 10 ? `\n...(+${rows.length-10})` : '');
});
$('#btnMerge').addEventListener('click', () => {
  const rows = parseMeta($('#paste').value);
  if (!rows.length) return alert('파싱 결과가 없습니다.');
  // 현재 페이지 상단에 병합(편집 대기)
  for (const r of rows) {
    const exist = state.rows.find(x => Number(x.seq) === Number(r.seq));
    if (exist) Object.assign(exist, r);
    else state.rows.unshift(r);
    state.edited.set(r.seq, r);
  }
  renderTable();
});
</script>
</body>
</html>
